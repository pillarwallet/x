version: 2.1

orbs:
  slack: circleci/slack@3.4.2

jobs:
  e2e-tests:
    working_directory: ~/x
    docker:
      - image: cypress/included:cypress-13.15.1-node-20.18.0-chrome-130.0.6723.69-1-ff-131.0.3-edge-130.0.2849.52-1
    resource_class: xlarge
    steps:
      - checkout

      - run:
          name: Install jq
          command: |
            apt-get update && apt-get install -y curl jq

      - run:
          name: Checkout x-e2e repo and run tests
          no_output_timeout: 90m
          command: |
            cd ~
            git clone -b pillarx-playwright --single-branch https://$GITHUB_TOKEN@github.com/pillarwallet/x-e2e.git
            cd x-e2e
            git pull
            touch .env
            sed -i "s|test_mail_email_value|$TESTMAIL_EMAIL|g" .env
            sed -i "s|test_mail_username_value|$TESTMAIL_USERNAME|g" .env
            sed -i "s|test_mail_apikey_value|$TESTMAIL_API_KEY|g" .env
            sed -i "s|staging_url_value|$STAGING_URL|g" .env
            sed -i "s|sushi_url_value|$SUSHI_URL|g" .env
            sed -i "s|ci_value|$CI|g" .env
            sed -i "s|headed_value|$HEADED|g" .env
            sed -i "s|debug_value|$DEBUG|g" .env
            npm install
            npx playwright install --with-deps
            npm run test:all

      - run:
          name: Move Playwright report + JSON results
          when: always
          command: |
            if [ -d "/root/x-e2e/blob-report" ]; then
              mv /root/x-e2e/blob-report /tmp/blob-report
              chmod 777 -R /tmp/blob-report
            else
              echo "blob-report folder not found!"
            fi

            if [ -d "/root/x-e2e/test-results" ]; then
              mv /root/x-e2e/test-results /tmp/test-results
              chmod 777 -R /tmp/test-results
            fi

      - store_artifacts:
          path: /tmp/blob-report
          when: always
      
      - store_artifacts:
          path: /tmp/test-results
          when: always

      - run:
          name: Parse Playwright results and send Slack
          when: always
          command: |
            RESULTS_FILE="/tmp/test-results/.last-run.json"

            if [ ! -f "$RESULTS_FILE" ]; then
              echo ".last-run.json not found â€” cannot generate Slack report"
              exit 0
            fi

            STATUS=$(jq -r '.status' $RESULTS_FILE)
            FAILED_TESTS=$(jq -r '.failedTests | join(", ")' $RESULTS_FILE)

            if [ "$STATUS" == "passed" ]; then
              SLACK_MESSAGE=":white_check_mark: All Playwright UI tests passed
            *Project:* ${CIRCLE_PROJECT_REPONAME}
            *Triggered by:* ${CIRCLE_USERNAME}
            *Branch:* ${CIRCLE_BRANCH}
            *Commit:* <https://github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/commit/${CIRCLE_SHA1}|${CIRCLE_SHA1}>
            *Report:* <https://output.circle-artifacts.com/output/job/${CIRCLE_WORKFLOW_JOB_ID}/artifacts/${CIRCLE_NODE_INDEX}/tmp/blob-report/index.html|View HTML Report>"
            else
              SLACK_MESSAGE=":x: *Playwright UI Tests Failed :x:*
            *Project:* ${CIRCLE_PROJECT_REPONAME}
            *Triggered by:* ${CIRCLE_USERNAME}
            *Branch:* ${CIRCLE_BRANCH}
            *Commit:* <https://github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/commit/${CIRCLE_SHA1}|${CIRCLE_SHA1}>
            *Failed Tests:* ${FAILED_TESTS}
            *Report:* <https://output.circle-artifacts.com/output/job/${CIRCLE_WORKFLOW_JOB_ID}/artifacts/${CIRCLE_NODE_INDEX}/tmp/blob-report/index.html|View HTML Report>"
            fi
            
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"${SLACK_MESSAGE}\"}" $E2E_SLACK_WEBHOOK_URL


  e2e-playwright:
    working_directory: ~/x
    docker:
      - image: cypress/included:cypress-13.15.1-node-20.18.0-chrome-130.0.6723.69-1-ff-131.0.3-edge-130.0.2849.52-1
    resource_class: xlarge
    steps:
      - checkout

      - run:
          name: Install jq
          command: |
            apt-get update && apt-get install -y curl jq

      - run:
          name: Checkout x-e2e repo and run Playwright tests
          no_output_timeout: 90m
          command: |
            cd ~
            git clone -b pillarx-playwright --single-branch https://$GITHUB_TOKEN@github.com/pillarwallet/x-e2e.git
            cd x-e2e
            git pull 
            touch .env
            sed -i "s|base_url_value|$BASE_URL|g" .env
            sed -i "s|dry_run_value|$DRY_RUN|g" .env
            sed -i "s|master_email_value|$MASTER_EMAIL|g" .env
            sed -i "s|master_wallet_value|$MASTER_WALLET|g" .env
            sed -i "s|testmail_api_key_value|$TESTMAIL_API_KEY|g" .env
            sed -i "s|testmail_namespace_value|$TESTMAIL_NAMESPACE|g" .env
            sed -i "s|recovery_recipient_address_value|$RECOVERY_RECIPIENT_ADDRESS|g" .env
            sed -i "s|minimum_amount_value|$MINIMUM_AMOUNT|g" .env
            sed -i "s|headless_value|$HEADLESS|g" .env
            sed -i "s|timeout_value|$TIMEOUT|g" .env
            sed -i "s|debug_value|$DEBUG|g" .env
            sed -i "s|ci_value|$CI|g" .env
            sed -i "s|headed_value|$HEADED|g" .env
            sed -i "s|sushi_url_value|$SUSHI_URL|g" .env
            sed -i "s|staging_url_value|$STAGING_URL|g" .env
            sed -i "s|testmail_username_value|$TESTMAIL_USERNAME|g" .env
            sed -i "s|testmail_email_value|$TESTMAIL_EMAIL|g" .env
            npm install
            npx playwright install
            npm run test:metamask -- --reporter=list,html,json

      - run:
          name: Move Playwright reports
          when: always
          command: |
            if [ -d "/root/x-e2e/test-results" ]; then
              mv /root/x-e2e/test-results /tmp/test-results
              chmod 777 -R /tmp/test-results
            fi

            if [ -d "/root/x-e2e/playwright-report" ]; then
              mv /root/x-e2e/playwright-report /tmp/playwright-report
              chmod 777 -R /tmp/playwright-report
            fi

      - store_artifacts:
          path: /tmp/test-results
          when: always
      
      - store_artifacts:
          path: /tmp/playwright-report
          when: always

      - run:
          name: Parse Playwright results and send Slack
          when: always
          command: |
            RESULTS_FILE="/tmp/test-results/.last-run.json"
            STATUS=$(jq -r '.status' $RESULTS_FILE)
            FAILED_TESTS=$(jq -r '.failedTests | join(", ")' $RESULTS_FILE)

            if [ "$STATUS" == "passed" ]; then
              SLACK_MESSAGE=":white_check_mark: All Playwright UI tests passed
            *Project:* ${CIRCLE_PROJECT_REPONAME}
            *Triggered by:* ${CIRCLE_USERNAME}
            *Branch:* ${CIRCLE_BRANCH}
            *Commit:* <https://github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/commit/${CIRCLE_SHA1}|${CIRCLE_SHA1}>
            *Report:* <https://output.circle-artifacts.com/output/job/${CIRCLE_WORKFLOW_JOB_ID}/artifacts/${CIRCLE_NODE_INDEX}/tmp/playwright-report/index.html|View HTML Report>"
            else
              SLACK_MESSAGE=":x: *Playwright UI Tests Failed :x:*
            *Project:* ${CIRCLE_PROJECT_REPONAME}
            *Triggered by:* ${CIRCLE_USERNAME}
            *Branch:* ${CIRCLE_BRANCH}
            *Commit:* <https://github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/commit/${CIRCLE_SHA1}|${CIRCLE_SHA1}>
            *Failed Tests:* ${FAILED_TESTS}
            *Report:* <https://output.circle-artifacts.com/output/job/${CIRCLE_WORKFLOW_JOB_ID}/artifacts/${CIRCLE_NODE_INDEX}/tmp/playwright-report/index.html|View HTML Report>"
            fi

            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"${SLACK_MESSAGE}\"}" $E2E_SLACK_WEBHOOK_URL


workflows:
  version: 2
  pr_triggered_e2e_tests:
    jobs:
      - e2e-tests:
          filters:
            branches:
              only:
                - e2e-playwright
      - e2e-playwright:
          filters:
            branches:
              only:
                - e2e-playwright
