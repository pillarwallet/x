version: 2.1

orbs:
  slack: circleci/slack@3.4.2

jobs:
  e2e-tests:
    working_directory: ~/x
    docker:
      - image: cypress/included:cypress-13.15.1-node-20.18.0-chrome-130.0.6723.69-1-ff-131.0.3-edge-130.0.2849.52-1
    resource_class: xlarge

    steps:
      - checkout

      - run:
          name: Install required tools
          command: |
            apt-get update && apt-get install -y curl jq

      - run:
          name: Checkout x-e2e repo and run Playwright tests
          no_output_timeout: 90m
          command: |
            cd ~
            git clone -b pillarx-playwright --single-branch https://$GITHUB_TOKEN@github.com/pillarwallet/x-e2e.git
            cd x-e2e

            touch .env
            sed -i "s|test_mail_email_value|$TESTMAIL_EMAIL|g" .env
            sed -i "s|test_mail_username_value|$TESTMAIL_USERNAME|g" .env
            sed -i "s|test_mail_apikey_value|$TESTMAIL_API_KEY|g" .env
            sed -i "s|staging_url_value|$STAGING_URL|g" .env
            sed -i "s|sushi_url_value|$SUSHI_URL|g" .env
            sed -i "s|ci_value|$CI|g" .env
            sed -i "s|headed_value|$HEADED|g" .env
            sed -i "s|debug_value|$DEBUG|g" .env

            npm install
            npx playwright install --with-deps
            npm run test:all

      - run:
          name: Move Playwright artifacts
          when: always
          command: |
            if [ -d "/root/x-e2e/blob-report" ]; then
              mv /root/x-e2e/blob-report /tmp/blob-report
            fi

            if [ -d "/root/x-e2e/test-results" ]; then
              mv /root/x-e2e/test-results /tmp/test-results
            fi

      - store_artifacts:
          path: /tmp/blob-report
          when: always

      - store_artifacts:
          path: /tmp/test-results
          when: always

      - run:
          name: Parse Playwright results + Fetch artifact URL + Send Slack
          when: always
          command: |
            RESULTS_FILE="/tmp/test-results/.last-run.json"

            if [ ! -f "$RESULTS_FILE" ]; then
              STATUS="unknown"
              FAILED_TESTS="N/A"
            else
              STATUS=$(jq -r '.status' $RESULTS_FILE)
              FAILED_TESTS=$(jq -r '.failedTests | join(", ")' $RESULTS_FILE)
            fi

            # -----------------------------
            # Fetch REAL S3 URL dynamically
            # -----------------------------
            ARTIFACT_URL=$(
              curl -s \
                -H "Circle-Token: $CIRCLECI_API_TOKEN" \
                "https://circleci.com/api/v2/project/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}/artifacts" \
              | jq -r '.items[] | select(.path|contains("blob-report/index.html")) | .url'
            )

            if [ -z "$ARTIFACT_URL" ]; then
              ARTIFACT_URL="(artifact not found)"
            fi

            JOB_URL="https://app.circleci.com/pipelines/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}/workflows/${CIRCLE_WORKFLOW_ID}"

            if [ "$STATUS" = "passed" ]; then
              SLACK_MESSAGE=":white_check_mark: All Playwright UI tests passed
            *Project:* ${CIRCLE_PROJECT_REPONAME}
            *Triggered by:* ${CIRCLE_USERNAME}
            *Branch:* ${CIRCLE_BRANCH}
            *Job:* <${JOB_URL}|Open Job>
            *Commit:* <https://github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/commit/${CIRCLE_SHA1}%7C${CIRCLE_SHA1}>
            *Report:* <${ARTIFACT_URL}|View HTML Report>"
            else
              SLACK_MESSAGE=":x: *Playwright UI Tests Failed*
            *Project:* ${CIRCLE_PROJECT_REPONAME}
            *Triggered by:* ${CIRCLE_USERNAME}
            *Branch:* ${CIRCLE_BRANCH}
            *Failed Tests:* ${FAILED_TESTS}
            *Job:* <${JOB_URL}|Open Job>
            *Commit:* <https://github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/commit/${CIRCLE_SHA1}%7C${CIRCLE_SHA1}>
            *Report:* <${ARTIFACT_URL}|View HTML Report>"
            fi

            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"${SLACK_MESSAGE}\"}" $E2E_SLACK_WEBHOOK_URL


workflows:
  version: 2
  pr_triggered_e2e_tests:
    jobs:
      - e2e-tests:
          filters:
            branches:
              only: e2e-playwright
