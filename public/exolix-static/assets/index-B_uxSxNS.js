import{b8 as v,b9 as G,b6 as E,bj as ne,b0 as a,ba as c,bk as F,bl as Se,b1 as l,bm as U,bn as $,bo as Ce,bp as ke,bq as xe,br as d,bs as V,bt as ae,bu as se,bv as P,bw as Q,bx as we,bg as D,by as Ae,bz as re,b2 as O,bA as x,bB as X,bC as Y,bb as A,bD as I,bh as L,bE as Ee,aN as ie,aU as be,aH as Re,aI as Ie,b4 as ce,b5 as q,bF as Fe,b3 as Ne,bG as Ue,bH as Me}from"./main-CDKDnvW7.js";import{c as j,d as ve,e as le,f as $e,g as De,h as Ge}from"./exchangeSelectors-DP50MkAx.js";import{s as Oe,i as Le,a as Pe,b as _e,c as We}from"./ratesSelectors-CrbtfYvr.js";import{c as M,a as Be}from"./coinsSlice-DSan2S0Z.js";import{_ as K,d as Z}from"./App-DCKfOddi.js";import{telegramActions as Ve}from"./telegramSlice-BqfObn-v.js";import{a as je,b as ze,c as Xe,E as ee}from"./transactionSelectors-Bz099tFA.js";import{c as S,a as He}from"./ratesSlice-DmdeARD_.js";import{z as i}from"./index-dIKOytT1.js";import{s as Je}from"./txToCookies-CjVnD0W0.js";import{c as p,a as Ye}from"./transactionSlice-BLjUsgVM.js";import"./tslib.es6-D9yd9Yl3.js";const{Axios:Yt,AxiosError:H,CanceledError:qt,isCancel:Kt,CancelToken:Qt,VERSION:Zt,all:eo,Cancel:to,isAxiosError:oo,spread:no,toFormData:ao,AxiosHeaders:so,HttpStatusCode:ro,formToJSON:io,getAdapter:co,mergeConfig:lo}=v,J=async(e,t)=>{const o=new AbortController,n=v.get(`${t}/currencies`,{params:e,signal:o.signal});return n[G]=()=>o.abort(),(await n).data};function*qe(){yield E(M.fetchCoins,Qe)}function*Ke(){try{yield ne(500,M.setSearch,function*(e){const{selectType:t,search:o}=e.payload,n={page:1};o&&(n.search=o),yield a(M.fetchCoins({params:n,selectType:t}))})}catch(e){console.error(e)}}function*Qe(e){const{params:t,selectType:o}=e.payload;try{const n=yield c(F),s=yield c(Se);s&&(t.apiToken=s);const y=yield l(J,t,n);yield a(M.fetchCoinsSuccess({selectType:o,page:t.page,coinsResponse:y}))}catch(n){yield a(M.fetchCoinsFailure()),console.error(n)}finally{(yield U())&&(yield a(M.cancelFetchCoins()))}}function*Ze(){try{const e=yield c(Oe,$),t=yield c(Ce),o=yield c(ke),n=yield c(xe),s=yield c(j),y=yield c(F),C=s.from.coin,k=s.to.coin;let m,h;if(t){const[g,w]=t.split(":").map(f=>f.toUpperCase());if(m=w?e.find(f=>f.code===g&&f.network.network===w):e.find(f=>f.code===g&&f.network.isDefault),!m){const u=(yield l(J,{search:g,withNetworks:!0},y)).data.find(r=>r.code===g);if(u){const r=w?u.networks.find(N=>N.network===w):u.networks.find(N=>N.isDefault);m={code:u.code,icon:u.icon,name:u.name,network:r||u.networks[0]}}}}if(o||n){const g=n||o,[w,f]=g.split(":").map(u=>u.toUpperCase());if(h=f?e.find(u=>u.code===w&&u.network.network===f):e.find(u=>u.code===w&&u.network.isDefault),!h){const r=(yield l(J,{search:w,withNetworks:!0},y)).data.find(N=>N.code===w);if(r){const N=f?r.networks.find(_=>_.network===f):r.networks.find(_=>_.isDefault);h={code:r.code,icon:r.icon,name:r.name,network:N||r.networks[0]}}}}m||(m=e.find(g=>g.code!==(h==null?void 0:h.code)&&g.network.isDefault)),h||(h=e.find(g=>g.code!==(m==null?void 0:m.code)&&g.network.isDefault)),m&&!C&&(yield a(d.setSelectCoin({selectType:$,coin:m}))),h&&!k&&(yield a(d.setSelectCoin({selectType:V,coin:h})))}catch(e){console.error(e)}}const et=async(e,t)=>{const o=new AbortController,n=v.get(`${t}/users/me`,{headers:{Authorization:`Bearer ${e}`},signal:o.signal});return n[G]=()=>o.abort(),(await n).data},tt=async(e,t)=>{const o=new AbortController,n=v.get(`${t}/verification`,{headers:{Authorization:`Bearer ${e}`},signal:o.signal});return n[G]=()=>o.abort(),(await n).data},ot=async(e,t)=>{const o=new AbortController,n=v.get(`${t}/rate`,{params:e,signal:o.signal});return n[G]=()=>o.abort(),(await n).data};function nt(e,t){return ae(o=>{const n=new URLSearchParams(e),s=new EventSource(`${t}/rate/sse?${n.toString()}`);return s.onmessage=y=>{const C=JSON.parse(y.data);Le(C)?o(C):console.error("Invalid data received from SSE",C)},s.onerror=y=>{console.error("SSE error",y)},()=>{s.close(),o(se)}})}function*at(){yield E(S.fetchRates,st)}function*st(e){const{params:t,initialRatesFetching:o}=e.payload;try{const n=yield c(P),s=yield c(F);let y={...t};n.apiToken&&(y={...y,apiToken:n.apiToken});const C=yield l(ot,y,s);yield a(S.fetchRatesSuccess()),yield a(S.updateRates(C)),o&&(yield a(S.setInitialRatesFetching(!1)))}catch(n){if(yield a(S.fetchRatesFailure()),n instanceof H&&n.response&&n.response.data&&_e(n.response.data)){const s=n.response.data,y=yield c(we);if(o&&y)s.minAmount&&(yield a(d.setAmount({selectType:$,amount:s.minAmount.toString()}))),s.maxAmount&&(yield a(d.setAmount({selectType:$,amount:s.maxAmount.toString()}))),yield a(S.setInitialRatesFetching(!1));else if(yield a(S.updateRates(s)),yield c(D)){const k=yield c(ve,"from"),m=s.message&&s.minAmount&&!s.maxAmount,h=s.message&&s.maxAmount&&!s.minAmount,g=`${m?`Min amount is ${s.minAmount} ${k==null?void 0:k.code}.`:h?`Max amount is ${s.maxAmount} ${k==null?void 0:k.code}.`:""}`,w=`${s.message}. ${g||""}`;yield a(Ae(w,"error"))}}console.error(n)}finally{(yield U())&&(yield a(S.cancelFetchRates()))}}function*rt(){yield E(S.startSse,function*(e){try{yield re({task:l(it,e),cancel:O(S.stopSse)})}catch(t){console.error(t)}})}function*it(e){let t=null;try{const o=yield c(P),n=yield c(F);let s={...e.payload};for(o.apiToken&&(s={...s,apiToken:o.apiToken}),t=yield l(nt,s,n);t;){const y=yield O(t);yield a(S.updateRates(y))}}finally{(yield U())&&t&&t.close()}}function*ct(){try{yield ne(350,[d.setSelectCoin,d.setRateType,d.setAmount,d.resetTimer],de)}catch(e){console.error(e)}}function*de(){try{const{from:e,to:t,rateType:o,mainSelectType:n}=yield c(j),s=yield c(Pe),y=yield c(P),C=Q(e.amount),k=Q(t.amount);if(e.coin&&t.coin&&(e.amount||t.amount)){const m={amount:e.amount,coinFrom:e.coin.code,coinTo:t.coin.code,coinFromNetwork:e.coin.network.network,coinToNetwork:t.coin.network.network,rateType:o};y.affiliateToken&&(m.affiliateToken=y.affiliateToken),(n===$&&C||n===V&&k)&&(n===V&&(m.withdrawalAmount=t.amount),yield a(S.fetchRates({params:m,initialRatesFetching:s})),yield a(S.startSse(m)))}}catch(e){console.error(e)}}function*lt(){yield E(S.updateRates,dt)}function*dt(e){const{fromAmount:t,toAmount:o}=e.payload;try{const n=yield c(le);yield a(d.updateAmount({selectType:n,amount:n===$?t.toString():o.toString()}))}catch(n){console.error(n)}}const yt=i.union([i.literal(x.WAIT),i.literal(x.CONFIRMATION),i.literal(x.CONFIRMED),i.literal(x.TRANSFERRING),i.literal(x.BUY_EXCHANGE),i.literal(x.SELL_EXCHANGE),i.literal(x.EXCHANGING),i.literal(x.SENDING),i.literal(x.SENDING_CONFIRMATION),i.literal(x.SUCCESS),i.literal(x.OVERDUE),i.literal(x.REFUND),i.literal(x.REFUNDED),i.literal(x.ERROR),i.literal(x.DELETED)]),ut=i.union([i.literal(X.FIXED),i.literal(X.FLOAT)]),te=i.object({coinCode:i.string(),coinName:i.string(),icon:i.string(),memoName:i.string().nullable(),network:i.string().optional(),networkName:i.string().optional(),networkShortName:i.string().nullable()}),oe=i.object({hash:i.string().nullable(),link:i.string().nullable()}).partial(),ft=i.object({id:i.string(),amount:i.number(),amountTo:i.number(),coinFrom:te,coinTo:te,comment:i.string().nullable(),createdAt:i.string(),depositAddress:i.string(),depositExtraId:i.string().nullable(),hashIn:oe,hashOut:oe,rate:i.number(),rateId:i.string().optional(),rateType:ut,refundAddress:i.string().nullable(),refundExtraId:i.string().nullable(),affiliateToken:i.string().nullable(),source:i.string().optional(),status:yt,withdrawalAddress:i.string(),withdrawalExtraId:i.string().nullable(),bonus:i.any().optional(),confirmations:i.string().optional()}),pt=i.object({error:i.string(),message:i.string(),errors:i.object({}).optional()}).partial(),mt=e=>{try{return ft.parse(e),!0}catch(t){return console.error(t),!1}},ye=e=>pt.safeParse(e).success,ht=async(e,t,o)=>{const n=new AbortController,s=v.post(`${o}/transactions`,e,{headers:t});return s[G]=()=>n.abort(),(await s).data};function gt(e,t){return ae(o=>{const n=new EventSource(`${t}/transactions/${e}/sse`);return n.onmessage=s=>{const y=JSON.parse(s.data);mt(y)?o(y):console.error("Invalid data received from SSE",y)},n.onerror=s=>{console.error("SSE error",s)},()=>{n.close(),o(se)}})}const Tt=async(e,t)=>{const o=new AbortController,n=v.get(`${t}/transactions/${e}`,{signal:o.signal});return n[G]=()=>o.abort(),(await n).data},St=async(e,t,o)=>{const n=new AbortController,s=v.post(`${o}/transactions/${e}/subscribe`,t);return s[G]=()=>n.abort(),(await s).data};function*Ct(){yield E(p.createTransaction,kt)}function*kt(){var e,t,o,n,s,y,C,k,m,h,g,w;try{const f=yield c(j),u=yield c(je),r=yield c(P),N=yield c($e),{rateType:_,from:W,to:B,exchangeAgain:me}=f,b=u.data;let R;f.exchangeAgain&&b?R={affiliateToken:b.affiliateToken?b.affiliateToken:"",amount:b.amount,apiToken:r.apiToken?r.apiToken:"",coinFrom:b.coinFrom.coinCode,coinTo:b.coinTo.coinCode,networkFrom:b.coinFrom.network,networkTo:b.coinTo.network,rateType:b.rateType,referrerLink:r.referrerLink,withdrawalAddress:b.withdrawalAddress,withdrawalExtraId:b.withdrawalExtraId?b.withdrawalExtraId:""}:(R={affiliateToken:r.affiliateToken,amount:Number(W.amount),apiToken:r.apiToken?r.apiToken:"",coinFrom:W.coin?W.coin.code:"",coinTo:B.coin?B.coin.code:"",networkFrom:W.coin?W.coin.network.network:"",networkTo:B.coin?B.coin.network.network:"",rateType:_,referrerLink:r.referrerLink,withdrawalAddress:u.withdrawalAddress,withdrawalExtraId:N?u.memoAddress:""},f.mainSelectType===V&&(R.withdrawalAmount=Number(B.amount)),u.emailAddress&&(R.email=u.emailAddress),u.promocode&&(R.promocode=u.promocode),r.clickId&&(R.clickId=r.clickId),r.utmSource&&(R.utmSource=r.utmSource),r.utmMedium&&(R.utmMedium=r.utmMedium),r.utmCampaign&&(R.utmCampaign=r.utmCampaign),r.isMobileApp&&(R.isMobileApp=!!r.isMobileApp));const T={"Content-Language":r.locale,Accept:"application/json"};(e=r.headers)!=null&&e.acceptLanguage&&(T["Accept-Language"]=r.headers.acceptLanguage),(t=r.headers)!=null&&t.authorization&&(T.Authorization=r.headers.authorization),(o=r.headers)!=null&&o.cookie&&(T["Ex-Cookie"]=r.headers.cookie),(n=r.headers)!=null&&n.origin&&(T["Ex-Origin"]=r.headers.origin),(s=r.headers)!=null&&s.referer&&(T["Ex-Referer"]=r.headers.referer),(y=r.headers)!=null&&y.secChUa&&(T["Sec-Ch-Ua"]=r.headers.secChUa),(C=r.headers)!=null&&C.secChUaMobile&&(T["Sec-Ch-Ua-Mobile"]=r.headers.secChUaMobile),(k=r.headers)!=null&&k.secChUaPlatform&&(T["Sec-Ch-Ua-Platform"]=r.headers.secChUaPlatform),(m=r.headers)!=null&&m.userAgent&&(T["User-Agent"]=r.headers.userAgent),(h=r.headers)!=null&&h.externalReferrer&&(T["Ex-External-Referrer"]=r.headers.externalReferrer),(g=r.headers)!=null&&g.entryReferrer&&(T["Ex-Entry-Referrer"]=r.headers.entryReferrer),(w=r.headers)!=null&&w.txReferrerParent?T["Ex-Tx-Referrer-Parent"]=r.headers.txReferrerParent:document.referrer&&(T["Ex-Tx-Referrer-Parent"]=document.referrer),document.URL&&(T["Ex-Tx-Referrer-Child"]=document.URL);const he=yield c(D),ge=yield c(F),Te=yield c(Y);he&&(yield a(d.getUser()),T.Authorization=Te);const z=yield l(ht,R,T,ge);yield a(A.postMessage({data:{event:I,payload:{type:"config/transactionId",id:z.id}},source:null})),yield a(d.setExchangeStep({exchangeStep:L.STEP_3,source:null})),yield a(p.updateTransaction(z)),yield a(p.createTransactionSuccess()),yield a(p.startSse(z.id)),yield a(S.stopSse()),me&&(yield a(d.setExchangeAgain(!1))),Je(z),Ee(!0)}catch(f){if(f instanceof H&&f.response&&ye(f.response.data)){let u;f.response.data.errors?(Object.keys(f.response.data.errors).includes("clickId")&&(yield a(A.postMessage({data:{event:I,payload:{type:"cex/clickIdError"}},source:null})),yield a(A.setClearClickId())),u=Object.values(f.response.data.errors).join(", ")):u=f.response.data.error||f.response.data.message,u&&(yield a(p.createTransactionFailure(u)),u.includes("withdrawal address")||((yield c(D))&&f.response.status===401?yield a(A.postMessage({data:{event:I,payload:{type:"cex/unauthorize",withoutRedirect:!1}},source:null})):K.error(u,{id:"createTransErr"})))}console.error(f)}finally{(yield U())&&(yield a(p.cancelCreateTransaction()))}}function*xt(){yield E(p.startSse,function*(e){try{yield re({task:l(wt,e),cancel:O(p.stopSse)})}catch(t){console.error(t)}})}function*wt(e){let t=null;try{const o=yield c(F),n=yield c(D);for(t=yield l(gt,e.payload,o);t;){const s=yield O(t);n&&(yield c(ze))!==s.status&&(yield a(A.postMessage({data:{event:I,payload:{type:"config/transactionId",id:s.id}},source:null}))),yield a(p.updateTransaction(s))}}finally{(yield U())&&t&&t.close()}}function*At(){yield E(p.fetchTransactionById,function*(e){try{const t=yield c(D),o=yield c(F),n=yield l(Tt,e.payload,o);yield a(p.updateTransaction(n)),yield a(p.fetchTransactionByIdSuccess()),t&&(yield a(A.postMessage({data:{event:I,payload:{type:"activeService",payload:ie.CEX}},source:null}))),yield a(p.startSse(n.id))}catch(t){if(t instanceof H&&t.response&&ye(t.response.data)){const o=t.response.data.error;o&&(yield a(p.fetchTransactionByIdFailure(o)),be()||K.error(o))}console.error(t)}finally{(yield U())&&(yield a(p.cancelFetchTransactionById()))}})}function*Et(){yield E(p.createSubscribeToTransaction,function*(e){try{const{id:t,email:o}=e.payload,n=yield c(F);yield l(St,t,{email:o},n),yield a(p.createSubscribeToTransactionSuccess())}catch(t){if(yield a(p.createSubscribeToTransactionFailure()),t instanceof H&&t.response){const o=t.response.data.message|t.response.data.error;o&&K.error(`${o}`)}console.error(t)}finally{(yield U())&&(yield a(p.cancelCreateSubscribeToTransaction()))}})}function*bt(){yield E(A.setTransactionId,ue)}function*ue(e){const{id:t,source:o}=e.payload;try{yield a(d.setExchangeStep({exchangeStep:L.STEP_3,source:o})),yield a(p.fetchTransactionById(t))}catch(n){console.error(n)}}function*fe(){try{const e=yield c(Z),t=yield c(Z);e&&!t&&(yield O(Ve.handleTelegramUserSuccess));const o=yield c(P),n=yield c(We),s=yield c(j),y=yield c(Xe),C=yield c(Re),k=yield c(Ie),m=yield c(D),h=!!(o.step&&o.step===L.STEP_2);(!C&&!k||m&&!o.transactionId)&&(yield a(A.postMessage({data:{event:I,payload:{type:"activeService",payload:ie.CEX}},source:null}))),m&&(h||o.transactionId)&&(yield l(pe)),o.transactionId?yield ue({type:A.setTransactionId.type,payload:{id:o.transactionId,source:window.parent}}):(y&&(yield a(p.stopSse())),(o.rateType&&o.rateType===X.FIXED||o.rateType===X.FLOAT)&&(yield a(d.setRateType(o.rateType))),o.recipient&&(yield a(p.setWithdrawalAddress(o.recipient))),o.recipientExtra&&(yield a(p.setMemoAddress(o.recipientExtra))),o.email&&(yield a(p.setEmailAddress(o.email))),o.promocode&&(yield a(p.setPromocode(o.promocode))),h&&(yield a(d.setExchangeStep({exchangeStep:L.STEP_2,source:window.parent}))),yield l(de),s.from.amount||(yield a(d.setAmount({amount:o.amountFrom,selectType:$}))),!s.to.amount&&o.amountTo&&(yield a(d.setAmount({amount:o.amountTo,selectType:V}))),(n.from.count===0||n.to.count===0)&&(yield a(M.fetchCoins()),yield O(M.fetchCoinsSuccess)),(!s.from.coin||!s.to.coin)&&(yield l(Ze)))}catch(e){console.error(e)}}function*Rt(){yield ce(d.setResetExchange,fe)}function*It(){yield ce(q.revertExchange,Ft)}function*Ft(){try{const e=yield c(j),t=yield c(De),o=yield c(le),n=e[t],s=e[o];yield a(S.removeRates()),yield a(d.setSelectCoin({selectType:t,coin:s.coin})),yield a(d.setSelectCoin({selectType:o,coin:n.coin})),yield a(d.updateAmount({selectType:t,amount:""})),yield a(d.setAmount({selectType:o,amount:n.amount}))}catch(e){console.error(e)}}function*Nt(){yield E(d.setExchangeStep,function*(e){const{exchangeStep:t,source:o}=e.payload;try{const n=yield c(P);yield a(A.postMessage({data:{event:I,payload:{type:"cex/setStep",step:t}},source:o})),t<L.STEP_3&&n.transactionId&&(yield a(A.setClearTransactionId()),yield a(d.setResetExchange()))}catch(n){console.error(n)}})}function*Ut(){yield E(d.getUser,pe)}function*pe(){try{const e=yield c(Y),t=yield c(F);(yield l(et,e||"",t)).userId&&(yield a(d.getUserSuccess()))}catch(e){yield a(d.getUserError()),(yield c(D))&&e.response.status===401&&(yield a(A.postMessage({data:{event:I,payload:{type:"cex/unauthorize",withoutRedirect:!0}},source:null}))),console.error(e)}finally{(yield U())&&(yield a(d.cancelGetUser()))}}function*Mt(){yield E(d.getUserVerification,function*(){try{const e=yield c(Y),t=yield c(F),o=yield c(Ge),n=yield l(tt,e||"",t);n.status&&(yield a(d.getUserVerificationSuccess(n.status)),n.status===ee.CONFIRMED&&o&&(yield a(d.setExchangeStep({exchangeStep:L.STEP_2,source:null}))))}catch(e){yield a(d.getUserVerificationError()),e.response.status===404&&(yield a(d.getUserVerificationSuccess(ee.NOT_FINISHED))),console.error(e)}finally{(yield U())&&(yield a(d.cancelGetUserVerification()))}})}function*vt(){yield E(q.outerLinkClicked,$t)}function*$t(e){try{yield a(A.postMessage({data:{event:I,payload:{type:"cex/outerLinkClicked",payload:e.payload}},source:null}))}catch(t){console.error(t)}}function*Dt(){yield E(q.newExchangeClicked,Gt)}function*Gt(){try{yield a(A.postMessage({data:{event:I,payload:{type:"cex/newExchangeClicked"}},source:null}))}catch(e){console.error(e)}}const yo=Fe({coins:Be,rates:He,formUi:Ue,exchange:Me,transaction:Ye});function*uo(){try{yield Ne([l(fe),l(Ut),l(Rt),l(qe),l(Ke),l(at),l(rt),l(lt),l(ct),l(It),l(Nt),l(Ct),l(At),l(xt),l(bt),l(Et),l(vt),l(Dt),l(Mt)])}catch(e){console.error(e)}}export{yo as cexReducer,uo as cexSaga};
